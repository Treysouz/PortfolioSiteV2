name: ðŸ‘€ Deploy Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy (leave empty for current branch)'
        required: false
        default: ''
        type: string

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: preview-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy Preview
    uses: ./.github/workflows/deploy.yml
    with:
      environment: 'Preview'
      production: false
      branch: ${{ inputs.branch }}
    secrets: inherit

  comment-coverage:
    name: Comment Coverage Results
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: Comment PR with Coverage
        uses: actions/github-script@v7
        with:
          script: |
            const testsPassed = '${{ needs.deploy.outputs.tests-passed }}' === 'true';
            const coverageSummary = `${{ needs.deploy.outputs.coverage-summary }}`;

            let comment = `## ðŸš€ Test Results\n\n`;

            // Coverage report
            if (testsPassed && coverageSummary && coverageSummary !== 'No coverage data available') {
              comment += `${coverageSummary}\n\n`;
            } else if (testsPassed) {
              comment += `ðŸ“Š **Test Coverage**: Coverage report not available\n\n`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  summary:
    name: Preview Summary
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Preview Deployment Summary
        run: |
          echo "âœ… Preview deployment completed!"

          # Create GitHub workflow summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ‘€ Preview Deployment Successful!

          | Item | Details |
          |------|---------|
          | ðŸ”— **Preview URL** | [${{ needs.deploy.outputs.deployment-url }}](${{ needs.deploy.outputs.deployment-url }}) |
          | ðŸ”€ **Branch** | \`${{ inputs.branch || github.head_ref || github.ref }}\` |

          EOF
